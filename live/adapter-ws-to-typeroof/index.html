<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title> - Documentation - TypeRoof</title>
        <meta name="viewport" content="initial-scale=1,shrink-to-fit=no">
        <link rel="stylesheet" href="../../lib/css/shell.css">
    </head>
    <body class="typeroof-docs">
        <div class="wrapper">
            <header>
                <h1>TypeRoof</h1>
            </header>
            <div class="typeroof-ui_sidebar">

                <h3>Content</h3>
                <nav>
                    <ul><li><a href="/TypeRoof/docs/">Landing Page</a><ul><li><a href="/TypeRoof/docs/usage/">User Kit</a></li>
<li><a href="/TypeRoof/docs/development/">Developer Kit</a></li></ul></li>
<li><a href="/TypeRoof/docs/states_lib/">States Library</a><ul><li><a href="/TypeRoof/docs/states_lib/demos/">/demos</a></li></ul></li>
<li><a href="/TypeRoof/README/">Project README</a></li></ul>
                </nav>
                <h3>Applications</h3>
                <ul class="typeroof-ui_sidebar-app_links">
                    <li><a href="../../shell">TypeRoof Shell</a></li>
                    <li><a href="../../legacy">TypeRoof Legacy</a></li>
                </ul>
            </div>
            <div class="typeroof-main">
                <div class="typeroof-docs_content"><!DOCTYPE html>
<html lang="en">
  <head>
    <title>Adapter WebSocket to TypeRoof</title>
    <script>

function main() {
    const socket = new WebSocket('ws://localhost:8765/');
    socket.binaryType = "arraybuffer";

    socket.addEventListener("open", (event) => {
        socket.send(JSON.stringify({ type: 'init' }));
    })

    const documentFonts = new Map()
      , lastMessages = new Map()
      , sendUpdatesTo = new Set()
      ;
    socket.addEventListener('message',  async (event) => {
        if (event.data instanceof ArrayBuffer) {
            // binary frame
            const view = new DataView(event.data)
              , metadataLength = view.getUint16(0)
              , metaDataBytes = event.data.slice(2, 2 + metadataLength)
              , decoder = new TextDecoder()
              , metaDataStr = decoder.decode(metaDataBytes)
              , metaData = JSON.parse(metaDataStr)
              , fontBuffer = event.data.slice(2 + metadataLength)
              ;
            const font = new FontFace(`"${metaData.fullName}"`, fontBuffer)
            await font.load();
            if(documentFonts.has(metaData.fullName)) {
                const oldFont = documentFonts.get(metaData.fullName);
                document.fonts.delete(oldFont);
            }
            else {
                const container = document.createElement('div');
                container.textContent = `${metaData.fullName} ABCabc1234`;
                container.style.fontFamily = `"${metaData.fullName}"`;
                container.style.fontSize = '3rem';
                document.body.append(container);
            }

            const message = {type: 'font-update', metaData, fontBuffer};
            lastMessages.set(metaData.fullName, message);

            documentFonts.set(metaData.fullName, font);
            document.fonts.add(font);
            for(const win of sendUpdatesTo)
                win.postMessage(message,  {targetOrigin: typeRoofOriginURL});
        }
    })

    const typeRoofOriginURL = 'https://fontbureau.github.io';
    // e.g. open /TypeRoof/shell from localhost:
    // const typeRoofOriginURL = 'http://localhost:8081';

    // open TypeRoof
    myHandle = window.open(`${typeRoofOriginURL}/TypeRoof/shell`, '_blank');

    // here
    window.addEventListener('message', event=> {
        console.log(`got message ${event}`, event);
        if(event.source !== myHandle){
            console.log('I don\'t know event.source:', event.source, 'it is not', myHandle);
            return;
        }
        if(event.data !== 'init-live-fonts'){
            console.log('I don\'t know what to do. event.data:', event.data);
            return;
        }

        console.log('sending updates ... to:', myHandle);
        sendUpdatesTo.add(myHandle);
        for(const lastMessage of lastMessages.values())
            myHandle.postMessage(lastMessage, {targetOrigin: typeRoofOriginURL});
    });

    // TypeRoof client:
    // window.addEventListener('message', (...a)=> console.log('ON MESAGE:',...a));
    // window.opener.postMessage('init-live-fonts', '*');
};

window.addEventListener('DOMContentLoaded', main);
    </script>
  </head>
  <body>
  </body>
</html>
</div>
            </div>
            <footer>
                <ul>
                    <li><a href="https://github.com/FontBureau/TypeRoof">Source code on GitHub</a></li><!--
                    --><li><a href="https://github.com/FontBureau/TypeRoof/issues">Bug reports &amp; feature&nbsp;requests</a></li>
                </ul>
            </footer>
        </div> <!-- wrapper -->
    </body>
</html>
